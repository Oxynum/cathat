(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};this.WebSocketRails=function(){function e(n,s){this.url=n,this.use_websockets=null!=s?s:!0,this.connection_stale=t(this.connection_stale,this),this.pong=t(this.pong,this),this.supports_websockets=t(this.supports_websockets,this),this.dispatch_channel=t(this.dispatch_channel,this),this.unsubscribe=t(this.unsubscribe,this),this.subscribe_private=t(this.subscribe_private,this),this.subscribe=t(this.subscribe,this),this.dispatch=t(this.dispatch,this),this.trigger_event=t(this.trigger_event,this),this.trigger=t(this.trigger,this),this.bind=t(this.bind,this),this.connection_established=t(this.connection_established,this),this.new_message=t(this.new_message,this),this.state="connecting",this.callbacks={},this.channels={},this.queue={},this._conn=this.supports_websockets()&&this.use_websockets?new e.WebSocketConnection(n,this):new e.HttpConnection(n,this),this._conn.new_message=this.new_message}return e.prototype.new_message=function(t){var n,s,i,r,o,a;for(a=[],i=0,r=t.length;r>i;i++)s=t[i],n=new e.Event(s),n.is_result()?(null!=(o=this.queue[n.id])&&o.run_callbacks(n.success,n.data),this.queue[n.id]=null):n.is_channel()?this.dispatch_channel(n):n.is_ping()?this.pong():this.dispatch(n),"connecting"===this.state&&"client_connected"===n.name?a.push(this.connection_established(n.data)):a.push(void 0);return a},e.prototype.connection_established=function(t){return this.state="connected",this.connection_id=t.connection_id,this._conn.flush_queue(t.connection_id),null!=this.on_open?this.on_open(t):void 0},e.prototype.bind=function(t,e){var n;return null==(n=this.callbacks)[t]&&(n[t]=[]),this.callbacks[t].push(e)},e.prototype.trigger=function(t,n,s,i){var r;return r=new e.Event([t,n,this.connection_id],s,i),this.queue[r.id]=r,this._conn.trigger(r)},e.prototype.trigger_event=function(t){var e,n;return null==(e=this.queue)[n=t.id]&&(e[n]=t),this._conn.trigger(t)},e.prototype.dispatch=function(t){var e,n,s,i,r;if(null!=this.callbacks[t.name]){for(i=this.callbacks[t.name],r=[],n=0,s=i.length;s>n;n++)e=i[n],r.push(e(t.data));return r}},e.prototype.subscribe=function(t){var n;return null==this.channels[t]?(n=new e.Channel(t,this),this.channels[t]=n,n):this.channels[t]},e.prototype.subscribe_private=function(t){var n;return null==this.channels[t]?(n=new e.Channel(t,this,!0),this.channels[t]=n,n):this.channels[t]},e.prototype.unsubscribe=function(t){return null!=this.channels[t]?(this.channels[t].destroy(),delete this.channels[t]):void 0},e.prototype.dispatch_channel=function(t){return null!=this.channels[t.channel]?this.channels[t.channel].dispatch(t.name,t.data):void 0},e.prototype.supports_websockets=function(){return"function"==typeof WebSocket||"object"==typeof WebSocket},e.prototype.pong=function(){var t;return t=new e.Event(["websocket_rails.pong",{},this.connection_id]),this._conn.trigger(t)},e.prototype.connection_stale=function(){return"connected"!==this.state},e}()}).call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};WebSocketRails.Event=function(){function e(e,n,s){var i;this.success_callback=n,this.failure_callback=s,this.run_callbacks=t(this.run_callbacks,this),this.attributes=t(this.attributes,this),this.serialize=t(this.serialize,this),this.is_ping=t(this.is_ping,this),this.is_result=t(this.is_result,this),this.is_channel=t(this.is_channel,this),this.name=e[0],i=e[1],null!=i&&(this.id=null!=i.id?i.id:65536*(1+Math.random())|0,this.channel=null!=i.channel?i.channel:void 0,this.data=null!=i.data?i.data:i,this.connection_id=e[2],null!=i.success&&(this.result=!0,this.success=i.success))}return e.prototype.is_channel=function(){return null!=this.channel},e.prototype.is_result=function(){return this.result===!0},e.prototype.is_ping=function(){return"websocket_rails.ping"===this.name},e.prototype.serialize=function(){return JSON.stringify([this.name,this.attributes()])},e.prototype.attributes=function(){return{id:this.id,channel:this.channel,data:this.data}},e.prototype.run_callbacks=function(t,e){return t===!0?"function"==typeof this.success_callback?this.success_callback(e):void 0:"function"==typeof this.failure_callback?this.failure_callback(e):void 0},e}()}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};WebSocketRails.HttpConnection=function(){function e(e,n){this.url=e,this.dispatcher=n,this.connectionClosed=t(this.connectionClosed,this),this.flush_queue=t(this.flush_queue,this),this.trigger=t(this.trigger,this),this.parse_stream=t(this.parse_stream,this),this.createXMLHttpObject=t(this.createXMLHttpObject,this),this._url=this.url,this._conn=this.createXMLHttpObject(),this.last_pos=0,this.message_queue=[],this._conn.onreadystatechange=this.parse_stream,this._conn.addEventListener("load",this.connectionClosed,!1),this._conn.open("GET",this._url,!0),this._conn.send()}return e.prototype.httpFactories=function(){return[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}]},e.prototype.createXMLHttpObject=function(){var t,e,n,s,i,r;for(s=!1,e=this.httpFactories(),i=0,r=e.length;r>i;i++){n=e[i];try{s=n()}catch(o){t=o;continue}break}return s},e.prototype.parse_stream=function(){var t,e;return 3===this._conn.readyState?(t=this._conn.responseText.substring(this.last_pos),this.last_pos=this._conn.responseText.length,t=t.replace(/\]\]\[\[/g,"],["),e=JSON.parse(t),this.dispatcher.new_message(e)):void 0},e.prototype.trigger=function(t){return"connected"!==this.dispatcher.state?this.message_queue.push(t):this.post_data(this.dispatcher.connection_id,t.serialize())},e.prototype.post_data=function(t,e){return $.ajax(this._url,{type:"POST",data:{client_id:t,data:e},success:function(){}})},e.prototype.flush_queue=function(t){var e,n,s,i;for(i=this.message_queue,n=0,s=i.length;s>n;n++)e=i[n],null!=t&&(e.connection_id=this.dispatcher.connection_id),this.trigger(e);return this.message_queue=[]},e.prototype.connectionClosed=function(t){var e;return e=new WebSocketRails.Event(["connection_closed",t]),this.dispatcher.state="disconnected",this.dispatcher.dispatch(e)},e}()}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};WebSocketRails.WebSocketConnection=function(){function e(e,n){this.url=e,this.dispatcher=n,this.flush_queue=t(this.flush_queue,this),this.on_error=t(this.on_error,this),this.on_close=t(this.on_close,this),this.on_message=t(this.on_message,this),this.trigger=t(this.trigger,this),this.url.match(/^wss?:\/\//)?console.log("WARNING: Using connection urls with protocol specified is depricated"):this.url="http:"===window.location.protocol?"ws://"+this.url:"wss://"+this.url,this.message_queue=[],this._conn=new WebSocket(this.url),this._conn.onmessage=this.on_message,this._conn.onclose=this.on_close,this._conn.onerror=this.on_error}return e.prototype.trigger=function(t){return"connected"!==this.dispatcher.state?this.message_queue.push(t):this._conn.send(t.serialize())},e.prototype.on_message=function(t){var e;return e=JSON.parse(t.data),this.dispatcher.new_message(e)},e.prototype.on_close=function(t){var e;return e=new WebSocketRails.Event(["connection_closed",t]),this.dispatcher.state="disconnected",this.dispatcher.dispatch(e)},e.prototype.on_error=function(t){var e;return e=new WebSocketRails.Event(["connection_error",t]),this.dispatcher.state="disconnected",this.dispatcher.dispatch(e)},e.prototype.flush_queue=function(){var t,e,n,s;for(s=this.message_queue,e=0,n=s.length;n>e;e++)t=s[e],this._conn.send(t.serialize());return this.message_queue=[]},e}()}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};WebSocketRails.Channel=function(){function e(e,n,s){var i,r;this.name=e,this._dispatcher=n,this.is_private=s,this._failure_launcher=t(this._failure_launcher,this),this._success_launcher=t(this._success_launcher,this),this.dispatch=t(this.dispatch,this),this.trigger=t(this.trigger,this),this.bind=t(this.bind,this),this.destroy=t(this.destroy,this),r=this.is_private?"websocket_rails.subscribe_private":"websocket_rails.subscribe",i=new WebSocketRails.Event([r,{data:{channel:this.name}},this._dispatcher.connection_id],this._success_launcher,this._failure_launcher),this._dispatcher.trigger_event(i),this._callbacks={}}return e.prototype.destroy=function(){var t,e;return e="websocket_rails.unsubscribe",t=new WebSocketRails.Event([e,{data:{channel:this.name}},this._dispatcher.connection_id]),this._dispatcher.trigger_event(t),this._callbacks={}},e.prototype.bind=function(t,e){var n;return null==(n=this._callbacks)[t]&&(n[t]=[]),this._callbacks[t].push(e)},e.prototype.trigger=function(t,e){var n;return n=new WebSocketRails.Event([t,{channel:this.name,data:e},this._dispatcher.connection_id]),this._dispatcher.trigger_event(n)},e.prototype.dispatch=function(t,e){var n,s,i,r,o;if(null!=this._callbacks[t]){for(r=this._callbacks[t],o=[],s=0,i=r.length;i>s;s++)n=r[s],o.push(n(e));return o}},e.prototype._success_launcher=function(t){return null!=this.on_success?this.on_success(t):void 0},e.prototype._failure_launcher=function(t){return null!=this.on_failure?this.on_failure(t):void 0},e}()}.call(this),function(){var t,e;window.Chat={},window.dispatcher=new WebSocketRails("cathat.herokuapp.com:3000/websocket"),t=0,e=0,dispatcher.on_open=function(){return console.log("Connection has been established")},Chat.create_location_message=function(t,e){return{latitude:t,longitude:e,body:$("#message_body").val().trim()}},Chat.get_message_list=function(t,e){return $.get("messages",{latitude:t,longitude:e},function(t){return $("#messages_list").html(t)})},Chat.send_message=function(t){var e;return e=Chat.create_location_message(t.coords.latitude,t.coords.longitude),MapManager.send_info_to_server(t.coords.latitude,t.coords.longitude),dispatcher.trigger("message_received",e),$("#message_body").val("")}}.call(this),function(){window.DOM={},DOM.add_message=function(t){return $("#messages_list").prepend($('<div class="email">'+t.email+'</div> <div class="body">'+t.body+'</div> <div class="created_at">'+t.created_at+'</div> <div class="latitude">'+t.latitude+'</div> <div class="longitude">'+t.longitude+"</div>"))},DOM.initialize_body_textarea=function(){return $("#message_body").keyup(function(t){var e;return t.preventDefault(),e=$("#message_body").val(),e=e.trim(),13===t.keyCode&&e?MapManager.getLocationAndSendMessage():void 0})},google.maps.event.addDomListener(window,"load",DOM.initialize_body_textarea),dispatcher.bind("message_received",DOM.add_message)}.call(this),function(){var t;window.MapManager={},t={},MapManager.initialize_map_and_messages=function(t){var e,n;return e=t.coords.latitude,n=t.coords.longitude,MapManager.send_info_to_server(e,n),MapManager.display_map(e,n),Chat.get_message_list(e,n)},MapManager.getLocation=function(){return navigator.geolocation?navigator.geolocation.getCurrentPosition(MapManager.initialize_map_and_messages,Utils.display_error):display_default_error},MapManager.getLocationAndSendMessage=function(){return navigator.geolocation?navigator.geolocation.getCurrentPosition(Chat.send_message,Utils.display_error):display_default_error},MapManager.add_marker=function(e,n,s){var i,r;return r=new google.maps.LatLng(e,n),i=new google.maps.Marker({position:r,map:t,title:s})},MapManager.display_map=function(e,n){var s;return s={center:new google.maps.LatLng(e,n),zoom:13},t=new google.maps.Map(document.getElementById("map_canvas"),s),MapManager.add_marker(e,n)},MapManager.send_info_to_server=function(t,e){return $.ajax({url:"update_position",type:"PUT",data:{latitude:t,longitude:e}})},google.maps.event.addDomListener(window,"load",MapManager.getLocation)}.call(this),function(){}.call(this),function(){window.Utils={},Utils.display_default_error=function(){var t;return t="An unknown error occurred."},Utils.display_error=function(t){var e;switch(t.code){case t.PERMISSION_DENIED:return e="User denied the request for Geolocation.";case t.POSITION_UNAVAILABLE:return e="Location information is unavailable.";case t.TIMEOUT:return e="The request to get user location timed out.";case t.UNKNOWN_ERROR:return e="An unknown error occurred."}},Utils.handle_error=function(t){return console.log(t)}}.call(this);